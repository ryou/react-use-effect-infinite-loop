# useEffectの無限ループ

## 結論

以下の2つを満たすと無限ループを起こす可能性が高い。

- useEffect内で、depsの生成元の階層かそれより親を再レンダリングさせる
- depsがオブジェクトである

## 理由

オブジェクトはuseMemo/useCallbackされていない限り再レンダリング時に参照が変わってしまう。なので、deps生成元の階層かそれより親が再レンダリングされるようなuseEffectはuseMemo/useCallbackが完全に徹底されていない限り無限ループが発生する。

useMemo/useCallbackの完全な徹底は、ほぼ実現されないと思っておいたほうが良いのでこのパターンをそもそも避けたほうが良い。（自分たちが書いたコードが完璧でも、ライブラリが徹底されていないケースがよくある）

## 参考

[useEffect の無限ループをいつの間にかしなくなった - fsubal](https://scrapbox.io/fsubal/useEffect_%E3%81%AE%E7%84%A1%E9%99%90%E3%83%AB%E3%83%BC%E3%83%97%E3%82%92%E3%81%84%E3%81%A4%E3%81%AE%E9%96%93%E3%81%AB%E3%81%8B%E3%81%97%E3%81%AA%E3%81%8F%E3%81%AA%E3%81%A3%E3%81%9F)

[気になったTwitterのスレッド](https://twitter.com/stin_factory/status/1342505355524231170)  
自分もReact公式に意味上の保証があると思うなって書いているから、もしかしてuseMemo/useCallbackを多用するの公式的には間違っているのか？って考えたりもしたけど、そうなるとじゃあどうやって効率的にパフォーマンス改善やんの？って話になる。（useMemo/useCallbackを徹底しないといざパフォーマンスがやばい箇所が出てきた時に改善が大変）  
あくまで「useMemo使えば意味上同じである際に確実に参照同一になっている」と思うなという意味であって、useMemoが参照同一を担保しないと壊れるようなコードを書くなという意味と捉えた。  
なもので、そもそも無限ループを起こすようなuseEffectはuseMemo/useCallbackを徹底しないのが悪いのではなく、そのようなuseEffectを書くのが悪いとなるのかなと思った。
